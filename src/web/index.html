<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Device List</title>
		<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.11.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="js/jquery-strings-0.3.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.11.custom.min.js"></script>
		<script type="text/javascript" src="js/UI.js"></script>
		<script type="text/javascript" src="js/JsonRpc.js"></script>
		<script type="text/javascript" src="js/Util.js"></script>

		<script type="text/javascript">
								
		function httpGetDevices()
		{
			var jrpc = new JsonRpc();
			
			var jrpc_http = new JsonRpcHttp(jrpc, "/devices");
			
			var currentId;
			var timer;
			var timerCall = function()
			{
				jrpc_http.sendRequest(
					Util.jsonRpcRequest('get_device_status', {id: currentId}),
					function(status)
					{
						UI.setCurrentStatus({id: currentId, status: status});	
					}
				);
			};
			
			var onExpand = function(collapsed, id)
			{
				if (collapsed || id != currentId)
					clearInterval(timer);

				if (!collapsed) {
					timer = setInterval(timerCall, 5000);
					currentId = id;
				}
			}
			
			var onClick = function(id, status)
			{
				jrpc_http.sendRequest(Util.jsonRpcRequest('set_device_status', {id: id, status: status}));
			}
			
			var onDevices = function(devices)
			{
				UI.markupDevices(devices);
				UI.showDevices(onExpand, onClick);			
			}
			
			jrpc_http.sendRequest(Util.jsonRpcRequest('get_devices'), onDevices);
		}
		
		function webSocketGetDevices()
		{		
			var jrpc = new JsonRpc();
			jrpc.addMethod("set_device_status", UI.setCurrentStatus);
			
			var ws = new WebSocket(Util.createWSURI(window.location, "/ws"));
			ws.onerror = function(){alert("Error in WebSocket connection!");};
			ws.onclose = function(){alert("WebSocket connection closed!");};
			
			var jrpc_ws = new JsonRpcWebSocket(jrpc, ws);
			
			var onClick = function(id, status)
			{
				jrpc_ws.sendRequest(Util.jsonRpcRequest('set_device_status', {id: id, status: status}));
				jrpc_ws.sendRequest(
					Util.jsonRpcRequest('get_device_status', {id: id}),
					function(newStatus)
					{
						UI.setCurrentStatus({id: id, status: newStatus});
					}
				);
			};
			
			var onDevices = function(devices)
			{
				UI.markupDevices(devices);
				UI.showDevices(function(){}, onClick);
			}
			ws.onopen = function()
			{
				jrpc_ws.sendRequest(Util.jsonRpcRequest('get_devices'), onDevices);
			}
		};
		
		$(function(){
			
			var hideButtons = function()
			{
				$(".button").button("destroy");
				$(".button").hide();
			};
			
			$("#button_ws").button().bind("click", function(){
				if (typeof WebSocket !== "function") {
					alert("Your browser doesn`t support WebSocket or this feature turned off!");
					return;
				}
				hideButtons();
				webSocketGetDevices();
			});
			
			$("#button_http").button().bind("click", function(){
				hideButtons();
				httpGetDevices();
			});					
		});
		</script>
	</head>
	<body>
		<div id="header" style="width:50%"><h1 style="text-align:center">Device List</h1></div>
		<div id="button_ws" class="button" style="margin-left:40px">WebSocket transport</div>
		<div id="button_http" class="button" style="margin-left:40px">HTTP transport</div>
		<div id="devices" style="width:50%"></div>
	</body>
</html>
