<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Device List</title>
		<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.11.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="js/jquery-strings-0.3.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.11.custom.min.js"></script>
		<script type="text/javascript" src="js/processing.js"></script>

		<script type="text/javascript" src="js/UI.js"></script>
		<script type="text/javascript" src="js/JsonRpc.js"></script>
		<script type="text/javascript" src="js/Util.js"></script>

		<script type="text/javascript">
		
		function initWebSocketConnection()
		{
			var ws = new WebSocket(Util.createWSURI(window.location, "/ws"));
			ws.onerror = function(){alert("Error in WebSocket connection!");};
			ws.onclose = function(){alert("WebSocket connection closed!");};
			
			return ws;
		}
		
		function initJrpcWebSocket(webSocket)
		{
			var jrpc = new JsonRpc();
			jrpc.addMethod("set_device_status", UI.setCurrentStatus);
			jrpc.addMethod("set_rtdevice_status", function(params){UI.refreshRT(params.id, params.status)});
			
			var jrpc_ws = new JsonRpcWebSocket(jrpc, webSocket);
			
			return jrpc_ws;
		}
		
		function initConsole(jrpc_ws)
		{
			$("#send_request").button().bind("click", function() {
				var method = $("#method_name").val();
				if (method == "") {
					alert("Enter method name!");
					return;
				}
				var params_raw = $("#method_params").val();
				var params = params_raw ? Util.decodeJSON(params_raw) : "";
				if ($("#is_notify").attr("checked")) {
					jrpc_ws.sendRequest(Util.jsonRpcRequest(method, params));
				} else {
					jrpc_ws.sendRequest(Util.jsonRpcRequest(method, params), function(response) {
						alert(Util.encodeJSON(response));
					});
				}
			});
			
			$("#is_notify").button();
		}
		
		function initDevices(jrpc_ws, webSocket)
		{		
			var onStart = function(id)
			{
				jrpc_ws.sendRequest(
					Util.jsonRpcRequest('rtdevice_start_track', {id: id})
				);
			};
			
			var onStop = function(id)
			{
				jrpc_ws.sendRequest(
					Util.jsonRpcRequest('rtdevice_stop_track', {id: id})
				);
			}
						
			var onDevices = function(devices)
			{
				UI.markupDevices(devices);
				UI.showDevices(function(id, status){
					jrpc_ws.sendRequest(Util.jsonRpcRequest('set_device_status', {id: id, status: status}));
				});
				UI.showRTDevices(onStart, onStop);
				
				$(devices).each(function(idx, device) {
					if (idx % 2 != 0 && device.type == "byte")
						jrpc_ws.sendRequest(Util.jsonRpcRequest('device_start_track', {id: device.id}));
				});
			}

			webSocket.onopen = function()
			{
				jrpc_ws.sendRequest(Util.jsonRpcRequest('get_devices'), onDevices);
			}
		};

		$(function(){

			if (typeof WebSocket !== "function") {
				alert("Your browser doesn`t support WebSocket or this feature turned off!");
				return;
			}

			var webSocket = initWebSocketConnection();
			var jrpc_ws = initJrpcWebSocket(webSocket);

			initDevices(jrpc_ws, webSocket);
			initConsole(jrpc_ws);
		});
		</script>
	</head>
	<body>
		<div id="header" class="ui-widget-header ui-corner-all ui-state-default" style="margin-bottom:15px;">
			<h1 style="text-align:center">Device List</h1>
		</div>
		<div id="console" class="ui-state-hover ui-corner-all ui-widget ui-state-default" style="padding:5px; text-align:center; margin-bottom:15px;">
			Method :<input type="text" id="method_name" value="get_device_status"/>
			Params :<input type="text" id="method_params" value='{"id":1}'/>
			<input type="checkbox" id="is_notify" style=""/><label for="is_notify">Notification</label>
			<div id="send_request">Send request</div>
		</div>
		<div id="devices" style="width:49%; display:inline-block;"></div>
		<div id="rtdevices" style="float:right; width:50%; display:inline-block;"></div>
	</body>
</html>
